// src/server.ts
import dotenv from 'dotenv';
import { app } from './app';
import { db } from './config/db';
import { env } from './config/env';

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// CARGAR VARIABLES DE ENTORNO
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
dotenv.config();

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// VERIFICAR VARIABLES REQUERIDAS
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
if (!env.JWT_SECRET) {
    console.error('โ ERROR: JWT_SECRET no estรก definido');
    process.exit(1);
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// PUERTO
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
const PORT = process.env.PORT || 5000;

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// FUNCIรN PARA INICIAR SERVIDOR
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
const startServer = async () => {
    try {
        // 1. Conectar a la base de datos
        await db.getConnection();
        console.log('โ Database connected');
        
        // 2. Iniciar servidor
        app.listen(PORT, () => {
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
            console.log(`๐ Server running on http://localhost:${PORT}`);
            console.log(`๐ API available at http://localhost:${PORT}/api`);
            console.log(`๐ฅ Health check: http://localhost:${PORT}/health`);
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
        });
        
    } catch (error) {
        console.error('โ Error starting server:', error);
        process.exit(1);
    }
};

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// MANEJO DE CIERRE GRACEFUL
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
process.on('SIGINT', async () => {
    console.log('\n๐ Shutting down gracefully...');
    
    // Cerrar conexiรณn a BD
    await db.end();
    console.log('โ Database connection closed');
    
    process.exit(0);
});

process.on('SIGTERM', async () => {
    console.log('\n๐ SIGTERM received, shutting down...');
    await db.end();
    process.exit(0);
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// INICIAR SERVIDOR
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
startServer();